#Requires -Version 5.1
<#
.SYNOPSIS
    Bootstrap script for chezmoi dotfiles setup on Windows
    
.DESCRIPTION
    This script will:
    1. Install chezmoi (via scoop or winget)
    2. Initialize chezmoi and apply dotfiles
    3. Install scoop if needed
    4. Install packages from scoop.json and winget.json
    5. Configure environment (XDG paths)
    
.PARAMETER Repository
    GitHub repository URL (default: YOUR_USERNAME/chezmoi-dotfiles)
    
.PARAMETER Branch
    Branch to clone (default: main)
    
.PARAMETER WhatIf
    Show what would be done without making changes
    
.EXAMPLE
    # One-command install from GitHub
    iwr -useb https://raw.githubusercontent.com/YOUR_USERNAME/chezmoi-dotfiles/main/bootstrap.ps1 | iex
    
.EXAMPLE
    # Local install
    .\bootstrap.ps1
    
.EXAMPLE
    # Test mode
    .\bootstrap.ps1 -WhatIf
#>

[CmdletBinding(SupportsShouldProcess)]
param(
    [string]$Repository = "YOUR_USERNAME/chezmoi-dotfiles",
    [string]$Branch = "main",
    [switch]$SkipPackages
)

$ErrorActionPreference = 'Stop'
$ProgressPreference = 'SilentlyContinue'

# ============================================================================
# Configuration
# ============================================================================

$Script:Stats = @{
    StartTime = Get-Date
    ChezmoiInstalled = $false
    ScoopInstalled = $false
    PackagesInstalled = 0
    ConfigsApplied = $false
}

# ============================================================================
# Helper Functions
# ============================================================================

function Write-Status {
    param(
        [Parameter(Mandatory)]
        [string]$Message,
        
        [ValidateSet('Info', 'Success', 'Warning', 'Error')]
        [string]$Type = 'Info'
    )
    
    $colors = @{
        Info = 'Cyan'
        Success = 'Green'
        Warning = 'Yellow'
        Error = 'Red'
    }
    
    $symbols = @{
        Info = 'â„¹'
        Success = 'âœ“'
        Warning = 'âš '
        Error = 'âœ—'
    }
    
    Write-Host "$($symbols[$Type]) " -ForegroundColor $colors[$Type] -NoNewline
    Write-Host $Message
}

function Test-CommandExists {
    param([string]$Command)
    $null -ne (Get-Command $Command -ErrorAction SilentlyContinue)
}

# ============================================================================
# Chezmoi Installation
# ============================================================================

function Install-Chezmoi {
    Write-Status "Checking chezmoi installation..." -Type Info
    
    if (Test-CommandExists chezmoi) {
        Write-Status "chezmoi is already installed" -Type Success
        $Script:Stats.ChezmoiInstalled = $true
        return $true
    }
    
    Write-Status "Installing chezmoi..." -Type Info
    
    # Try scoop first (preferred for CLI tools)
    if (Test-CommandExists scoop) {
        Write-Status "Using scoop to install chezmoi..." -Type Info
        try {
            scoop install chezmoi
            $Script:Stats.ChezmoiInstalled = $true
            Write-Status "chezmoi installed via scoop" -Type Success
            return $true
        } catch {
            Write-Status "Scoop installation failed: $_" -Type Warning
        }
    }
    
    # Fallback to winget
    if (Test-CommandExists winget) {
        Write-Status "Using winget to install chezmoi..." -Type Info
        try {
            winget install --id twpayne.chezmoi --source winget --accept-package-agreements --accept-source-agreements
            $Script:Stats.ChezmoiInstalled = $true
            Write-Status "chezmoi installed via winget" -Type Success
            
            # Refresh PATH
            $env:PATH = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
            return $true
        } catch {
            Write-Status "Winget installation failed: $_" -Type Error
            return $false
        }
    }
    
    Write-Status "No package manager found (scoop or winget required)" -Type Error
    return $false
}

# ============================================================================
# Scoop Installation
# ============================================================================

function Install-Scoop {
    if (Test-CommandExists scoop) {
        Write-Status "scoop is already installed" -Type Success
        $Script:Stats.ScoopInstalled = $true
        return $true
    }
    
    Write-Status "Installing scoop..." -Type Info
    
    try {
        # Check execution policy
        $currentPolicy = Get-ExecutionPolicy -Scope CurrentUser
        if ($currentPolicy -eq 'Restricted') {
            Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        }
        
        # Install scoop
        Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
        
        $Script:Stats.ScoopInstalled = $true
        Write-Status "scoop installed successfully" -Type Success
        return $true
    } catch {
        Write-Status "Failed to install scoop: $_" -Type Error
        return $false
    }
}

# ============================================================================
# Chezmoi Initialization
# ============================================================================

function Initialize-Chezmoi {
    param([string]$Repo, [string]$Branch)
    
    Write-Status "Initializing chezmoi from $Repo..." -Type Info
    
    $repoUrl = if ($Repo -notmatch '^https?://') {
        "https://github.com/$Repo.git"
    } else {
        $Repo
    }
    
    try {
        # Initialize chezmoi from repository
        chezmoi init --apply --branch $Branch $repoUrl
        
        $Script:Stats.ConfigsApplied = $true
        Write-Status "Dotfiles applied successfully" -Type Success
        return $true
    } catch {
        Write-Status "Failed to initialize chezmoi: $_" -Type Error
        return $false
    }
}

# ============================================================================
# Environment Configuration
# ============================================================================

function Set-EnvironmentVariables {
    Write-Status "Configuring XDG environment variables..." -Type Info
    
    $xdgVars = @{
        'XDG_CONFIG_HOME' = "$env:USERPROFILE\.config"
        'XDG_DATA_HOME' = "$env:USERPROFILE\.local\share"
        'XDG_STATE_HOME' = "$env:USERPROFILE\.local\state"
        'XDG_CACHE_HOME' = "$env:USERPROFILE\.cache"
    }
    
    foreach ($var in $xdgVars.GetEnumerator()) {
        [Environment]::SetEnvironmentVariable($var.Key, $var.Value, 'User')
        Set-Item -Path "env:$($var.Key)" -Value $var.Value
    }
    
    Write-Status "XDG environment variables configured" -Type Success
}

# ============================================================================
# Main Execution
# ============================================================================

function Main {
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
    Write-Host "â•‘   Chezmoi Dotfiles Bootstrap (Windows)   â•‘" -ForegroundColor Cyan
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
    Write-Host ""
    
    # Step 1: Install chezmoi
    if (-not (Install-Chezmoi)) {
        Write-Status "Bootstrap failed: Could not install chezmoi" -Type Error
        exit 1
    }
    
    # Step 2: Install scoop (if needed for packages)
    if (-not $SkipPackages) {
        Install-Scoop | Out-Null
    }
    
    # Step 3: Initialize chezmoi and apply dotfiles
    if (-not (Initialize-Chezmoi -Repo $Repository -Branch $Branch)) {
        Write-Status "Bootstrap failed: Could not apply dotfiles" -Type Error
        exit 1
    }
    
    # Step 4: Configure environment
    Set-EnvironmentVariables
    
    # Summary
    Write-Host ""
    Write-Host "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Green
    Write-Host "â•‘          Bootstrap Complete! ğŸ‰           â•‘" -ForegroundColor Green
    Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
    Write-Host ""
    Write-Status "Chezmoi installed: $($Script:Stats.ChezmoiInstalled)" -Type Info
    Write-Status "Scoop installed: $($Script:Stats.ScoopInstalled)" -Type Info
    Write-Status "Configs applied: $($Script:Stats.ConfigsApplied)" -Type Info
    
    $elapsed = (Get-Date) - $Script:Stats.StartTime
    Write-Status "Total time: $($elapsed.TotalSeconds.ToString('F2'))s" -Type Info
    
    Write-Host ""
    Write-Status "Next steps:" -Type Info
    Write-Host "  1. Restart your terminal to load new configs"
    Write-Host "  2. Run: chezmoi diff (to see applied changes)"
    Write-Host "  3. Run: chezmoi edit --apply <file> (to modify configs)"
    Write-Host ""
    Write-Status "For package installation, chezmoi scripts will run on next apply" -Type Info
    Write-Host ""
}

# Run main function
if ($MyInvocation.InvocationName -ne '.') {
    Main
}
