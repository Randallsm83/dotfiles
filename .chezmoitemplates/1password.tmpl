{{- /* 1Password integration helpers */ -}}
{{- /* Usage: {{ template "1password" . }} */ -}}

# ============================================================================
# 1Password Integration Functions
# ============================================================================

# Check if 1Password CLI is available
has_1password_cli() {
    command_exists op
}

# Check if 1Password CLI is authenticated
is_1password_authenticated() {
    if ! has_1password_cli; then
        return 1
    fi
    
    # Try to run a simple command
    if op whoami >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Get 1Password account information
get_1password_account() {
    if ! is_1password_authenticated; then
        echo "not-authenticated"
        return 1
    fi
    
    op whoami --format json 2>/dev/null | jq -r '.account' || echo "unknown"
}

# Prompt for 1Password authentication if needed
ensure_1password_auth() {
    if is_1password_authenticated; then
        log_success "1Password CLI is authenticated"
        return 0
    fi
    
    if ! has_1password_cli; then
        log_warning "1Password CLI not installed"
        return 1
    fi
    
    log_info "1Password authentication required"
    log_info "Please authenticate with: op signin"
    
    # Try to sign in
    if op signin 2>/dev/null; then
        log_success "1Password authentication successful"
        return 0
    else
        log_error "1Password authentication failed"
        return 1
    fi
}

# Check if a specific 1Password item exists
has_1password_item() {
    local item_name="$1"
    local vault="${2:-}"
    
    if ! is_1password_authenticated; then
        return 1
    fi
    
    local args=()
    if [ -n "${vault}" ]; then
        args+=(--vault "${vault}")
    fi
    
    if op item get "${item_name}" "${args[@]}" >/dev/null 2>&1; then
        return 0
    fi
    
    return 1
}

# Get field value from 1Password item
get_1password_field() {
    local item_name="$1"
    local field_name="$2"
    local vault="${3:-}"
    
    if ! is_1password_authenticated; then
        log_error "1Password not authenticated"
        return 1
    fi
    
    local args=(item get "${item_name}" --fields "${field_name}")
    
    if [ -n "${vault}" ]; then
        args+=(--vault "${vault}")
    fi
    
    op "${args[@]}" 2>/dev/null
}

# Get document from 1Password
get_1password_document() {
    local item_name="$1"
    local vault="${2:-}"
    
    if ! is_1password_authenticated; then
        log_error "1Password not authenticated"
        return 1
    fi
    
    local args=(document get "${item_name}")
    
    if [ -n "${vault}" ]; then
        args+=(--vault "${vault}")
    fi
    
    op "${args[@]}" 2>/dev/null
}

# Print 1Password integration status
print_1password_status() {
    log_info "1Password Integration Status:"
    
    if has_1password_cli; then
        local version
        version=$(op --version 2>/dev/null || echo "unknown")
        log_info "  CLI Version:   ${version}"
        
        if is_1password_authenticated; then
            local account
            account=$(get_1password_account)
            log_success "  Authenticated: yes (${account})"
        else
            log_warning "  Authenticated: no"
        fi
    else
        log_warning "  CLI Installed: no"
        log_info "  Install: https://1password.com/downloads/command-line/"
    fi
}

# Validate 1Password secrets are accessible
validate_1password_secrets() {
    local required_items=("$@")
    local missing=()
    
    if ! is_1password_authenticated; then
        log_error "1Password not authenticated - cannot validate secrets"
        return 1
    fi
    
    log_info "Validating 1Password secrets..."
    
    for item in "${required_items[@]}"; do
        if has_1password_item "${item}"; then
            log_success "  ${item}: found"
        else
            log_warning "  ${item}: missing"
            missing+=("${item}")
        fi
    done
    
    if [ ${#missing[@]} -gt 0 ]; then
        log_error "Missing ${#missing[@]} required secret(s)"
        log_error "Please create these items in 1Password:"
        for item in "${missing[@]}"; do
            log_error "  - ${item}"
        done
        return 1
    fi
    
    log_success "All required secrets found"
    return 0
}

# ============================================================================
# Age Encryption Fallback
# ============================================================================

# Check if age encryption is available
has_age() {
    command_exists age && command_exists age-keygen
}

# Get age public key
get_age_public_key() {
    local key_file="${1:-{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt}"
    
    if [ ! -f "${key_file}" ]; then
        return 1
    fi
    
    age-keygen -y "${key_file}" 2>/dev/null
}

# Decrypt age-encrypted file
decrypt_age_file() {
    local encrypted_file="$1"
    local key_file="${2:-{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt}"
    
    if ! has_age; then
        log_error "age not installed"
        return 1
    fi
    
    if [ ! -f "${encrypted_file}" ]; then
        log_error "Encrypted file not found: ${encrypted_file}"
        return 1
    fi
    
    if [ ! -f "${key_file}" ]; then
        log_error "Age key not found: ${key_file}"
        return 1
    fi
    
    age --decrypt -i "${key_file}" "${encrypted_file}" 2>/dev/null
}

# Print age encryption status
print_age_status() {
    log_info "Age Encryption Status:"
    
    if has_age; then
        local version
        version=$(age --version 2>/dev/null | head -1 || echo "unknown")
        log_info "  Installed:    yes (${version})"
        
        local key_file="{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"
        if [ -f "${key_file}" ]; then
            local pubkey
            pubkey=$(get_age_public_key)
            log_success "  Key Found:    yes"
            log_info "  Public Key:   ${pubkey}"
        else
            log_warning "  Key Found:    no"
            log_info "  Generate:     age-keygen -o ${key_file}"
        fi
    else
        log_warning "  Installed:    no"
        log_info "  Install:      mise use -g age"
    fi
}

# ============================================================================
# Secrets Manager Selection
# ============================================================================

# Determine which secrets manager to use
get_secrets_manager() {
    # Check for explicit configuration
    {{- if .use_1password }}
    if has_1password_cli && is_1password_authenticated; then
        echo "1password"
        return 0
    fi
    {{- end }}
    
    {{- if .use_age }}
    if has_age && [ -f "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt" ]; then
        echo "age"
        return 0
    fi
    {{- end }}
    
    # Auto-detect
    if has_1password_cli && is_1password_authenticated; then
        echo "1password"
        return 0
    fi
    
    if has_age && [ -f "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt" ]; then
        echo "age"
        return 0
    fi
    
    echo "none"
    return 1
}

# Print secrets management status
print_secrets_status() {
    log_info "Secrets Management Status:"
    log_info ""
    
    local manager
    manager=$(get_secrets_manager)
    
    case "${manager}" in
        1password)
            log_success "  Active Manager: 1Password"
            print_1password_status
            ;;
        age)
            log_success "  Active Manager: age (encryption)"
            print_age_status
            ;;
        none)
            log_warning "  Active Manager: none"
            log_warning "  Secrets management not configured"
            log_info ""
            log_info "  Setup Options:"
            log_info "    1. Install 1Password CLI and authenticate"
            log_info "    2. Install age and generate key: age-keygen -o ~/.config/chezmoi/key.txt"
            ;;
    esac
}

# Export secrets manager variable
export CHEZMOI_SECRETS_MANAGER="$(get_secrets_manager)"
