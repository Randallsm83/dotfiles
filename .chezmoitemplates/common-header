{{- /* Common shell script header with error handling and logging */ -}}
{{- /* Usage: {{ template "common-header" . }} */ -}}
#!/usr/bin/env {{ if eq .chezmoi.os "darwin" }}bash{{ else }}bash{{ end }}
#
# Common shell script header
# Provides error handling, logging, and color output functions
# Generated by chezmoi - do not edit directly

set -euo pipefail
IFS=$'\n\t'

# ============================================================================
# Color Output Functions
# ============================================================================

# Color codes
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# Logging functions with timestamps
log_info() {
    echo -e "${CYAN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} â„¹  $*" >&2
}

log_success() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} âœ“  $*" >&2
}

log_warning() {
    echo -e "${YELLOW}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} âš   $*" >&2
}

log_error() {
    echo -e "${RED}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} âœ—  $*" >&2
}

log_debug() {
    if [ "${DEBUG:-0}" = "1" ]; then
        echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} ðŸ” $*" >&2
    fi
}

# ============================================================================
# Error Handling
# ============================================================================

# Error trap handler
error_handler() {
    local line_no=$1
    local bash_lineno=$2
    local command="$3"
    log_error "Command failed at line ${line_no}: ${command}"
    exit 1
}

# Set error trap
trap 'error_handler ${LINENO} ${BASH_LINENO} "$BASH_COMMAND"' ERR

# Cleanup trap handler (override in script if needed)
cleanup() {
    log_debug "Cleanup function called"
}

trap cleanup EXIT

# ============================================================================
# Utility Functions
# ============================================================================

# Check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if running with sudo
has_sudo() {
    if [ "$EUID" -eq 0 ]; then
        return 0
    fi
    if command_exists sudo && sudo -n true 2>/dev/null; then
        return 0
    fi
    return 1
}

# Dry run mode check
is_dry_run() {
    [ "${CHEZMOI_DRY_RUN:-0}" = "1" ] || [ "${DRY_RUN:-0}" = "1" ]
}

# Execute command with dry-run support
execute() {
    if is_dry_run; then
        log_info "[DRY RUN] Would execute: $*"
        return 0
    else
        log_debug "Executing: $*"
        "$@"
    fi
}

# ============================================================================
# Installation Logging
# ============================================================================

# Log directory
readonly LOG_DIR="{{ .chezmoi.homeDir }}/.local/state/chezmoi"
readonly LOG_FILE="${LOG_DIR}/install.log"

# Initialize logging
init_logging() {
    mkdir -p "${LOG_DIR}"
    log_info "Logging to ${LOG_FILE}"
    echo "========================================" >> "${LOG_FILE}"
    echo "Installation started: $(date)" >> "${LOG_FILE}"
    echo "Script: $0" >> "${LOG_FILE}"
    echo "========================================" >> "${LOG_FILE}"
}

# Log to file
log_to_file() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" >> "${LOG_FILE}"
}

# Initialize logging if not already done
if [ ! -f "${LOG_FILE}" ] || [ -z "${LOGGING_INITIALIZED:-}" ]; then
    init_logging
    export LOGGING_INITIALIZED=1
fi
