---
name: "Reset Arch Linux WSL"
command: |-
  # Minimal WSL bootstrap - chezmoi handles everything else
  $ErrorActionPreference = 'Continue'
  $logFile = Join-Path $env:TEMP "wsl-reset-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
  
  function Write-Log {
      param($Message, $Color = 'White')
      $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
      Add-Content -Path $logFile -Value "[$timestamp] $Message"
      Write-Host $Message -ForegroundColor $Color
  }
  
  Write-Log "Log file: $logFile" 'Gray'
  
  Write-Log "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" 'Cyan'
  Write-Log "â•‘  Resetting Arch Linux WSL Instance       â•‘" 'Cyan'
  Write-Log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" 'Cyan'
  
  Write-Log "âš  WARNING: This will DELETE ALL DATA in the archlinux WSL instance" 'Yellow'
  $confirm = Read-Host "`nContinue? (y/N)"
  
  if ($confirm -ne "y" -and $confirm -ne "Y") {
      Write-Log "`nâœ— Operation cancelled" 'Red'
      return
  }
  
  # Step 1: Unregister existing instance
  Write-Log "`nâ–¶ Step 1/5: Unregistering existing archlinux WSL..." 'Cyan'
  wsl --unregister archlinux 2>&1 | Out-Null
  if ($LASTEXITCODE -eq 0) {
      Write-Log "âœ“ WSL instance unregistered" 'Green'
  } else {
      Write-Log "  (No existing instance found)" 'Gray'
  }
  
  # Step 2: Install fresh Arch Linux
  Write-Log "`nâ–¶ Step 2/5: Installing fresh Arch Linux..." 'Cyan'
  wsl --install archlinux --no-launch 2>&1 | Out-String | Write-Log -Color 'Gray'
  Write-Log "âœ“ Arch Linux installed" 'Green'
  
  # Step 3: Wait for WSL to be ready
  Write-Log "`nâ–¶ Step 3/5: Waiting for WSL to be ready..." 'Cyan'
  Start-Sleep -Seconds 5
  $ready = $false
  for ($i = 1; $i -le 10; $i++) {
      $result = wsl -d archlinux echo "ready" 2>&1 | Out-String
      if ($result -match "ready") {
          $ready = $true
          break
      }
      Start-Sleep -Seconds 2
  }
  if (-not $ready) {
      Write-Log "âœ— WSL instance did not become ready" 'Red'
      return
  }
  Write-Log "âœ“ WSL instance ready" 'Green'
  
  # Step 4: Create user with sudo (minimal - no packages)
  Write-Log "`nâ–¶ Step 4/5: Creating user account..." 'Cyan'
  $username = $env:USERNAME.ToLower()
  
  # Install only sudo (required for chezmoi scripts) and curl (required to fetch chezmoi)
  $bootstrapScript = @"
  set -e
  # Install minimal bootstrap packages
  pacman -Sy --noconfirm sudo curl git
  # Create user with sudo access
  useradd -m -G wheel -s /bin/bash $username
  passwd -d $username
  mkdir -p /etc/sudoers.d
  echo '$username ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/$username
  chmod 440 /etc/sudoers.d/$username
  # Set default user in wsl.conf
  echo -e '[user]\ndefault=$username' > /etc/wsl.conf
  "@
  
  wsl -d archlinux -u root bash -c $bootstrapScript 2>&1 | Out-String | ForEach-Object { Write-Log $_ 'Gray' }
  if ($LASTEXITCODE -ne 0) {
      Write-Log "âœ— Failed to create user" 'Red'
      return
  }
  Write-Log "âœ“ User '$username' created with sudo access" 'Green'
  
  # Restart WSL to apply user settings
  Write-Log "`n  Restarting WSL to apply user settings..." 'Gray'
  wsl --terminate archlinux
  Start-Sleep -Seconds 3
  
  # Step 5: Bootstrap with chezmoi (chezmoi handles EVERYTHING else)
  Write-Log "`nâ–¶ Step 5/5: Bootstrapping with chezmoi..." 'Cyan'
  Write-Log "  Repository: Randallsm83/dotfiles" 'Gray'
  Write-Log "  Chezmoi will install: base packages, locale, zsh, mise, tools, runtimes" 'Gray'
  Write-Log "  Duration: ~10-15 minutes`n" 'Gray'
  
  # Install chezmoi to ~/.local/bin (in user's PATH) and run init --apply
  # Use single quotes to prevent PowerShell from interpreting $HOME
  # --ssh flag ensures SSH remote URL for 1Password SSH agent auth
  wsl -d archlinux bash -c 'set -e; mkdir -p "$HOME/.local/bin"; curl -fsSL https://get.chezmoi.io | sh -s -- -b "$HOME/.local/bin"; "$HOME/.local/bin/chezmoi" init --apply --ssh Randallsm83/dotfiles'
  
  if ($LASTEXITCODE -ne 0) {
      Write-Log "`nâš  Bootstrap encountered issues" 'Yellow'
      Write-Log "Retry manually: wsl -d archlinux" 'White'
      Write-Log "  chezmoi init --apply --ssh Randallsm83/dotfiles" 'White'
      return
  }
  
  Write-Log "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" 'Green'
  Write-Log "â•‘          Setup Complete! ğŸ‰              â•‘" 'Green'
  Write-Log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" 'Green'
  
  Write-Log "Next steps:" 'White'
  Write-Log "  1. Launch: wsl -d archlinux" 'White'
  Write-Log "  2. Shell should auto-switch to zsh with starship prompt" 'White'
  Write-Log "  3. Verify: mise --version && chezmoi --version`n" 'White'
tags:
  - wsl
  - arch
  - dotfiles
  - chezmoi
  - setup
description: |-
  Minimal reset and bootstrap of Arch Linux WSL instance.
  
  This workflow does the MINIMUM required to bootstrap:
  1. Unregister existing 'archlinux' WSL distribution
  2. Install fresh Arch Linux from WSL repository  
  3. Create user with sudo access
  4. Install chezmoi to ~/.local/bin and run init --apply
  
  Chezmoi handles EVERYTHING else:
  - Base packages (build tools, zsh, etc.)
  - Locale generation (en_US.UTF-8)
  - mise and all CLI tools
  - Language runtimes
  - Shell configuration
  - 1Password integration
  
  Duration: 10-15 minutes
  Prerequisites: WSL2 enabled, internet connection
  
  âš ï¸ WARNING: DESTRUCTIVE - deletes all data in archlinux WSL instance.

# vim: ts=2 sts=2 sw=2 et
