---
name: "Reset Arch Linux WSL"
command: |-
  # Prevent script from exiting on errors
  $ErrorActionPreference = 'Continue'
  
  # Enable verbose logging
  $VerbosePreference = 'Continue'
  $logFile = Join-Path $env:TEMP "wsl-reset-$(Get-Date -Format 'yyyyMMdd-HHmmss').log"
  function Write-Log {
      param($Message, $Color = 'White')
      $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
      $logMessage = "[$timestamp] $Message"
      Add-Content -Path $logFile -Value $logMessage
      Write-Host $Message -ForegroundColor $Color
  }
  
  Write-Log "Log file: $logFile" 'Gray'
  Write-Log "PowerShell version: $($PSVersionTable.PSVersion)" 'Gray'
  Write-Log "Working directory: $PWD" 'Gray'
  
  # Terminate existing Arch Linux WSL instance
  Write-Log "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" 'Cyan'
  Write-Log "â•‘  Resetting Arch Linux WSL Instance       â•‘" 'Cyan'
  Write-Log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" 'Cyan'
  
  Write-Log "âš  WARNING: This will DELETE ALL DATA in the archlinux WSL instance" 'Yellow'
  $confirm = Read-Host "`nContinue? (y/N)"
  
  if ($confirm -ne "y" -and $confirm -ne "Y") {
      Write-Log "`nâœ— Operation cancelled" 'Red'
      exit 0
  }
  Write-Log "User confirmed operation" 'Gray'
  
  Write-Log "`nâ–¶ Step 1/5: Unregistering existing archlinux WSL..." 'Cyan'
  Write-Log "Running: wsl --unregister archlinux" 'Gray'
  $unregOutput = wsl --unregister archlinux 2>&1 | Out-String
  Write-Log "Exit code: $LASTEXITCODE" 'Gray'
  Write-Log "Output: $unregOutput" 'Gray'
  if ($LASTEXITCODE -ne 0) {
      Write-Log "  (No existing instance found, continuing...)" 'Gray'
  } else {
      Write-Log "âœ“ WSL instance unregistered" 'Green'
  }
  
  Write-Log "`nâ–¶ Step 2/5: Installing fresh Arch Linux..." 'Cyan'
  Write-Log "  (This may take a few minutes)" 'Gray'
  Write-Log "Running: wsl --install archlinux --no-launch" 'Gray'
  $installOutput = wsl --install archlinux --no-launch 2>&1 | Out-String
  Write-Log "Exit code: $LASTEXITCODE" 'Gray'
  Write-Log "Output: $installOutput" 'Gray'
  if ($LASTEXITCODE -ne 0) {
      Write-Log "âš  Warning: Install command returned non-zero exit code" 'Yellow'
  }
  Write-Log "âœ“ Arch Linux installed" 'Green'
  
  Write-Log "`nâ–¶ Step 3/5: Waiting for WSL to be ready..." 'Cyan'
  Write-Log "Initial 5 second wait..." 'Gray'
  Start-Sleep -Seconds 5
  
  # Test if WSL is ready
  Write-Log "Testing WSL readiness (up to 10 attempts)..." 'Gray'
  $ready = $false
  $attempts = 0
  while (-not $ready -and $attempts -lt 10) {
      $attempts++
      Write-Log "  Attempt $attempts/10: Testing WSL connection..." 'Gray'
      try {
          $result = wsl -d archlinux echo "ready" 2>&1 | Out-String
          Write-Log "  Result: $result" 'Gray'
          if ($result -match "ready") {
              $ready = $true
              Write-Log "  WSL responded successfully!" 'Gray'
          } else {
              Write-Log "  WSL not ready yet, waiting 2 seconds..." 'Gray'
              Start-Sleep -Seconds 2
          }
      } catch {
          Write-Log "  Exception: $($_.Exception.Message)" 'Yellow'
          Start-Sleep -Seconds 2
      }
  }
  if ($ready) {
      Write-Log "âœ“ WSL instance ready" 'Green'
  } else {
      Write-Log "âœ— WSL instance did not become ready after 10 attempts" 'Red'
      Write-Log "Check log file for details: $logFile" 'Yellow'
      exit 1
  }
  
  Write-Log "`nâ–¶ Step 4/5: Installing essential packages..." 'Cyan'
  Write-Log "  Installing: bash, curl, git" 'Gray'
  $packagesOutput = wsl -d archlinux pacman -Sy --noconfirm bash curl git 2>&1 | Out-String
  Write-Log "Packages output: $packagesOutput" 'Gray'
  if ($LASTEXITCODE -ne 0) {
      Write-Log "âœ— Failed to install packages" 'Red'
      Write-Log "Full output logged to: $logFile" 'Yellow'
      exit 1
  }
  Write-Log "âœ“ Essential packages installed" 'Green'
  
  Write-Log "`nâ–¶ Step 5/5: Bootstrapping with chezmoi dotfiles..." 'Cyan'
  Write-Log "  Repository: Randallsm83/dotfiles" 'Gray'
  Write-Log "  Duration: ~10-15 minutes (installing packages and runtimes)" 'Gray'
  Write-Log "  You can monitor progress in the WSL terminal`n" 'Gray'
  
  # Use official chezmoi one-line installer
  Write-Log "Running official chezmoi installer..." 'Gray'
  $bootstrapOutput = wsl -d archlinux bash -c 'sh -c "$(curl -fsLS get.chezmoi.io)" -- init --apply Randallsm83/dotfiles' 2>&1 | Out-String
  Write-Log "Exit code: $LASTEXITCODE" 'Gray'
  Write-Log "Bootstrap output:`n$bootstrapOutput" 'Gray'
  
  if ($LASTEXITCODE -ne 0) {
      Write-Log "`nâš  Bootstrap encountered issues (exit code: $LASTEXITCODE)" 'Yellow'
      Write-Log "Full output logged to: $logFile" 'Yellow'
      Write-Log "You can retry manually from within WSL:" 'Yellow'
      Write-Log "  wsl -d archlinux" 'White'
      Write-Log "  sh -c '\$(curl -fsLS get.chezmoi.io)' -- init --apply Randallsm83/dotfiles`n" 'White'
      exit 1
  }
  
  Write-Log "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" 'Green'
  Write-Log "â•‘          Setup Complete! ğŸ‰              â•‘" 'Green'
  Write-Log "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n" 'Green'
  
  Write-Log "Log file saved to: $logFile" 'Gray'
  Write-Log "Next steps:" 'White'
  Write-Log "  1. Launch WSL:     wsl -d archlinux" 'White'
  Write-Log "  2. Restart shell:  exec zsh" 'White'
  Write-Log "  3. Verify setup:   starship --version && mise --version`n" 'White'
tags:
  - wsl
  - arch
  - dotfiles
  - chezmoi
  - setup
description: |-
  Complete reset and bootstrap of Arch Linux WSL instance with chezmoi dotfiles.
  
  This workflow will:
  1. Unregister (delete) the existing 'archlinux' WSL distribution
  2. Install a fresh Arch Linux instance from WSL repository
  3. Wait for WSL to be ready
  4. Install essential packages (bash, curl, git)
  5. Bootstrap with chezmoi dotfiles from GitHub (installs all tools/runtimes)
  
  What gets installed:
  - mise (package & runtime manager)
  - CLI tools: ripgrep, fd, bat, eza, delta, starship, zoxide, fzf
  - Language runtimes: Node.js, Python, Ruby, Go, Rust, Lua, Bun, Deno
  - Neovim with LazyVim config
  - Zsh with starship prompt (onedark theme)
  - 1Password SSH agent integration
  - All dotfiles and configurations
  
  Duration: 10-15 minutes total
  Prerequisites: WSL2 enabled, internet connection
  
  âš ï¸ WARNING: This is a DESTRUCTIVE operation. All data in the current
  archlinux WSL instance will be deleted. You will be prompted to confirm.
