# =============================================================================
# MISE CONFIGURATION
# =============================================================================
# Platform-specific tool management strategy:
#
#   Windows:
#     - mise: Language runtimes (node, python, ruby, go, rust, bun, deno, etc.)
#     - scoop: CLI tools (bat, eza, fd, ripgrep, starship, neovim, etc.)
#     - winget: GUI applications
#
#   Linux/WSL/macOS:
#     - mise: Everything (CLI tools + language runtimes)
#     - homebrew: macOS GUI apps only (warp, wezterm)
# =============================================================================

[tools]
# === Language Runtimes ===
{{- range $feature := list "node" "python" "ruby" "golang" "rust" "perl" "php" }}
{{- if index $.package_features $feature }}
{{- $mapping := index $.package_mapping $feature }}
{{- if hasKey $mapping $.chezmoi.os }}
{{- $platform := index $mapping $.chezmoi.os }}
{{- range $platform.mise }}
{{- template "mise-tool-entry" . }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- if and .package_features.lua (ne .chezmoi.os "windows") }}
{{- $luaMapping := index .package_mapping "lua" }}
{{- if hasKey $luaMapping .chezmoi.os }}
{{- $platform := index $luaMapping .chezmoi.os }}
{{- range $platform.mise }}
{{- template "mise-tool-entry" . }}
{{- end }}
{{- end }}
{{- end }}

# === Always-Installed Tools ===
{{- range .always_install.mise }}
{{- template "mise-tool-entry" . }}
{{- end }}

# === Feature-Gated Tools ===
{{- range $feature := list "direnv" "git" "nvim" "vim" "starship" "bat" "eza" "ripgrep" "fd" "fzf" "zoxide" "delta" "vivid" "glow" "btop" "navi" "sqlite3" "tealdeer" "fastfetch" }}
{{- if and (hasKey $.package_features $feature) (index $.package_features $feature) }}
{{- $mapping := index $.package_mapping $feature }}
{{- if hasKey $mapping $.chezmoi.os }}
{{- $platform := index $mapping $.chezmoi.os }}
{{- range $platform.mise }}
{{- template "mise-tool-entry" . }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

{{- if ne .chezmoi.os "windows" }}
# === Build Tools (Unix) ===
{{- range .always_install.mise_unix }}
{{- template "mise-tool-entry" . }}
{{- end }}
# NOTE: thefuck cannot be installed via pipx/uv - setuptools 82 removed
# pkg_resources which thefuck's setup.py still imports. Install via system
# package manager instead (pacman, apt, brew). Tracking:
# https://github.com/pypa/setuptools/issues/5174
{{- end }}

[settings]
idiomatic_version_file = true
idiomatic_version_file_disable_tools = []
always_keep_download = false
always_keep_install = false
plugin_autoupdate_last_check_duration = '1 week'
trusted_config_paths = ['']
verbose = false
http_timeout = "30s"
jobs = 4
raw = false
yes = false
not_found_auto_install = false
task_output = "prefix"
paranoid = false
shorthands_file = '~/.config/mise/shorthands.toml'
disable_default_shorthands = false
experimental = true
status = { missing_tools = "if_other_versions_installed", show_env = false, show_tools = false }

{{- if eq .chezmoi.os "windows" }}
# Disable tools that don't work well via mise on Windows
# rust: mise can't detect its own junction on Windows (ln -sf fails with os error 183)
#       rustup + cargo/bin in PATH (via 50-mise.ps1) works fine without mise
disable_tools = ["lua", "luajit", "rust"]
{{- else }}
disable_tools = []
{{- end }}
# NOTE: ignored_config_paths and ceiling_paths are early-init settings.
# They MUST be set via environment variables (MISE_IGNORED_CONFIG_PATHS,
# MISE_CEILING_PATHS), NOT in mise.toml. See 01-mise.zsh for WSL setup.

# cargo
cargo = { binstall = true }

# node
node = {}

# npm - use bun instead
npm = { bun = true }

{{- if ne .chezmoi.os "windows" }}
# pipx - use uv instead
pipx = { uvx = true }
{{- end }}

# python
python = {}

# ruby
ruby = {}

[_]
# Comments and metadata

[env]
# Workaround for luarocks 3.13.0 corrupted rockspec (upstream bug)
LUAROCKS_VERSION = "3.11.1"
