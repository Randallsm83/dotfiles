{{- if eq .chezmoi.os "windows" -}}
#!/usr/bin/env pwsh
#
# Install packages on Windows
# This script runs once after chezmoi initialization

$ErrorActionPreference = 'Continue'  # Continue on non-critical errors
$ProgressPreference = 'SilentlyContinue'

# Status logging functions
function Write-Status {
    param(
        [string]$Message,
        [ValidateSet('Info', 'Success', 'Warning', 'Error')]
        [string]$Type = 'Info'
    )
    
    $colors = @{ Info = 'Cyan'; Success = 'Green'; Warning = 'Yellow'; Error = 'Red' }
    $symbols = @{ Info = 'ℹ'; Success = '✓'; Warning = '⚠'; Error = '✗' }
    
    Write-Host "$($symbols[$Type]) " -ForegroundColor $colors[$Type] -NoNewline
    Write-Host $Message
}

function Test-CommandExists {
    param([string]$Command)
    $null -ne (Get-Command $Command -ErrorAction SilentlyContinue)
}

Write-Host "╔══════════════════════════════════════════╗" -ForegroundColor Cyan
Write-Host "║       Installing Windows Packages       ║" -ForegroundColor Cyan  
Write-Host "╚══════════════════════════════════════════╝" -ForegroundColor Cyan
Write-Host ""

# Install scoop packages from export file
if (Test-CommandExists scoop) {
    $scoopFile = "$env:USERPROFILE\.local\share\chezmoi\scoop-packages.json"
    if (Test-Path $scoopFile) {
        Write-Status "Installing scoop packages from $scoopFile..." -Type Info
        try {
            scoop import $scoopFile
            Write-Status "Scoop packages installed" -Type Success
        } catch {
            Write-Status "Failed to import scoop packages: $_" -Type Warning
        }
    } else {
        Write-Status "Scoop export file not found, skipping package installation" -Type Warning
    }
} else {
    Write-Status "Scoop not available" -Type Error
    exit 1
}

# Install winget packages from export file
if (Test-CommandExists winget) {
    $wingetFile = "$env:USERPROFILE\.local\share\chezmoi\winget-packages.json"
    if (Test-Path $wingetFile) {
        Write-Status "Installing winget packages from $wingetFile..." -Type Info
        try {
            winget import -i $wingetFile --accept-package-agreements --accept-source-agreements --no-upgrade
            Write-Status "Winget packages installed" -Type Success
        } catch {
            Write-Status "Failed to import winget packages: $_" -Type Warning
        }
    } else {
        Write-Status "Winget export file not found, skipping GUI app installation" -Type Warning
    }
} else {
    Write-Status "Winget not available, skipping GUI app installation" -Type Warning
}

if (Test-CommandExists mise) {
    Write-Status "Installing tools and runtimes via mise config..." -Type Info
    Write-Status "Config: ~/.config/mise/config.toml" -Type Info
    
    try {
        # Mise will read config.toml and config.windows.toml automatically
        mise install
        Write-Status "Mise tools installed successfully" -Type Success
    } catch {
        Write-Status "Failed to install mise tools: $_" -Type Warning
    }
} else {
    Write-Status "Mise not available, skipping package installation" -Type Warning
}

Write-Host ""
Write-Status "Package installation completed!" -Type Success
Write-Host ""
{{- end }}