{{- if ne .chezmoi.os "windows" -}}
{{ template "common-header" . }}
{{ template "platform-detect" . }}
{{ template "1password" . }}

#
# Validate secrets management setup
# This script runs before other installation scripts to ensure secrets are accessible
# Hash: {{ include ".chezmoidata.yaml" | sha256sum }}

# ============================================================================
# Main Validation Logic
# ============================================================================

log_info "═══════════════════════════════════════════"
log_info "   Validating Secrets Management"
log_info "═══════════════════════════════════════════"
log_info ""

# Print comprehensive secrets status
print_secrets_status
log_info ""

# Get active secrets manager (|| true to prevent set -e from exiting)
manager=$(get_secrets_manager) || true

case "${manager}" in
    1password)
        log_info "Validating 1Password configuration..."
        
        # Define required secrets (customize this list based on your needs)
        required_secrets=(
            {{- if .setup_git_ssh }}
            "SSH Private Key"
            {{- end }}
            {{- if .setup_1password }}
            "GitHub Token"
            {{- end }}
        )
        
        if [ ${#required_secrets[@]} -gt 0 ]; then
            if validate_1password_secrets "${required_secrets[@]}"; then
                log_success "1Password secrets validated successfully"
            else
                log_warning "Some 1Password secrets are missing"
                log_warning "Continuing anyway - secrets will be skipped where needed"
            fi
        else
            log_info "No secrets validation required for this configuration"
        fi
        ;;
        
    age)
        log_info "Validating age encryption configuration..."
        
        key_file="{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"
        if [ -f "${key_file}" ]; then
            if get_age_public_key >/dev/null 2>&1; then
                log_success "Age encryption key is valid"
            else
                log_error "Age encryption key is invalid or corrupted"
                log_error "Generate new key: age-keygen -o ${key_file}"
                exit 1
            fi
        else
            log_error "Age encryption key not found: ${key_file}"
            log_error "Generate key: age-keygen -o ${key_file}"
            exit 1
        fi
        ;;
        
    none)
        log_warning "No secrets manager configured"
        log_info "Some features requiring secrets will be disabled:"
        
        {{- if .setup_git_ssh }}
        log_warning "  - SSH key management"
        {{- end }}
        {{- if .setup_1password }}
        log_warning "  - GitHub token integration"
        {{- end }}
        
        log_info ""
        log_info "To enable secrets management:"
        log_info "  Option 1: Install and configure 1Password CLI"
        log_info "    - Download: https://1password.com/downloads/command-line/"
        log_info "    - Authenticate: op signin"
        log_info ""
        log_info "  Option 2: Use age encryption"
        log_info "    - Install: mise use -g age"
        log_info "    - Generate key: age-keygen -o ~/.config/chezmoi/key.txt"
        log_info ""
        
        # Allow continuing without secrets (with confirmation in interactive mode)
        if [ -t 0 ] && [ "${CI:-false}" != "true" ]; then
            read -p "Continue without secrets management? [y/N] " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                log_info "Bootstrap cancelled"
                exit 0
            fi
        fi
        
        log_info "Continuing without secrets management..."
        ;;
esac

log_info ""
log_success "Secrets validation completed"
log_info ""

# Log to file
log_to_file "Secrets manager: ${manager}"
log_to_file "Secrets validation: completed"

{{- end -}}
