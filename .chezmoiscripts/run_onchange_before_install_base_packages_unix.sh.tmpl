{{- if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash
#
# Install base system packages required for building software
# This runs BEFORE other package installations
# Checksum: {{ include ".chezmoidata.yaml" | sha256sum }}

set -eo pipefail

# Ensure Arch perl scripts are in PATH (for pod2man used by Homebrew)
# This is normally set by /etc/profile.d/perlbin.sh but we may not be in a login shell
if [ -d /usr/bin/core_perl ]; then
    export PATH="/usr/bin/core_perl:/usr/bin/vendor_perl:/usr/bin/site_perl:$PATH"
fi

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Setup locale (required for many tools to work correctly)
# This MUST run first, before any package installations to avoid UTF-8 warnings
setup_locale() {
    log_info "Checking locale configuration..."
    
    # Set locale environment variables for current session immediately
    # This prevents warnings even if locale isn't fully generated yet
    export LANG="en_US.UTF-8"
    export LC_ALL="en_US.UTF-8"
    export LANGUAGE="en_US.UTF-8"
    
    # Check if en_US.UTF-8 locale is available
    if locale -a 2>/dev/null | grep -qi "en_US.utf8\|en_US.UTF-8"; then
        log_success "en_US.UTF-8 locale already available"
        return 0
    fi
    
    log_info "Generating en_US.UTF-8 locale..."
    
    # Detect package manager by checking for locale.gen or distro-specific files
    if [ -f /etc/locale.gen ]; then
        # Arch Linux / Gentoo / etc - uncomment locale in locale.gen and generate
        if [ "$EUID" -eq 0 ]; then
            sed -i 's/^#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen
            locale-gen 2>/dev/null || true
        elif command_exists sudo; then
            sudo sed -i 's/^#en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen
            sudo locale-gen 2>/dev/null || true
        else
            log_warning "Cannot generate locale without root/sudo"
            return 1
        fi
    elif [ -f /etc/debian_version ]; then
        # Debian/Ubuntu
        if command_exists locale-gen; then
            if [ "$EUID" -eq 0 ]; then
                locale-gen en_US.UTF-8 2>/dev/null || true
            elif command_exists sudo; then
                sudo locale-gen en_US.UTF-8 2>/dev/null || true
            fi
        fi
    elif [ -f /etc/fedora-release ] || [ -f /etc/redhat-release ]; then
        # Fedora/RHEL - install glibc-langpack
        if [ "$EUID" -eq 0 ]; then
            dnf install -y glibc-langpack-en 2>/dev/null || true
        elif command_exists sudo; then
            sudo dnf install -y glibc-langpack-en 2>/dev/null || true
        fi
    fi
    
    log_success "Locale configured"
}

is_zsh_default_shell() {
    local current_shell
    if [ -n "$SUDO_USER" ]; then
        current_shell=$(getent passwd "$SUDO_USER" | cut -d: -f7)
    else
        current_shell=$(getent passwd "$USER" | cut -d: -f7)
    fi
    [ "$current_shell" = "$(command -v zsh)" ] || [ "$current_shell" = "/bin/zsh" ] || [ "$current_shell" = "/usr/bin/zsh" ]
}

set_zsh_as_default_shell() {
    if ! command_exists zsh; then
        log_warning "zsh not found in PATH, skipping shell change"
        return 1
    fi
    
    if is_zsh_default_shell; then
        log_success "zsh is already the default shell"
        return 0
    fi
    
    local zsh_path
    zsh_path=$(command -v zsh)
    
    log_info "Setting zsh as default shell..."
    log_warning "You may be prompted for your password"
    
    if [ "$EUID" -eq 0 ] && [ -n "$SUDO_USER" ]; then
        # Running as root, change shell for the actual user
        if chsh -s "$zsh_path" "$SUDO_USER" 2>/dev/null; then
            log_success "Default shell changed to zsh for user $SUDO_USER"
            return 0
        fi
    elif command_exists sudo; then
        # Try with sudo (for WSL and other environments where chsh needs root)
        if sudo chsh -s "$zsh_path" "$USER" 2>/dev/null; then
            log_success "Default shell changed to zsh"
            return 0
        fi
    else
        # Running as normal user without sudo
        if chsh -s "$zsh_path" 2>/dev/null; then
            log_success "Default shell changed to zsh"
            return 0
        fi
    fi
    
    # chsh failed - provide fallback instructions
    log_warning "Failed to change default shell automatically"
    log_warning "Please run manually: chsh -s $zsh_path"
    log_warning "Or add this to /etc/passwd if in a container environment"
    return 1
}

# Setup locale first (required for many tools)
setup_locale

# Check if we need to install packages
needs_install=false

if ! command_exists git; then
    log_warning "git not found"
    needs_install=true
fi

if ! command_exists curl; then
    log_warning "curl not found"
    needs_install=true
fi

if ! command_exists make; then
    log_warning "make not found"
    needs_install=true
fi

if ! command_exists unzip; then
    log_warning "unzip not found"
    needs_install=true
fi

if [ "$needs_install" = false ]; then
    log_success "Base packages already installed"
{{- if not .is_remote }}
    # Still check and set zsh as default shell if needed
    if command_exists zsh && ! is_zsh_default_shell; then
        # Don't fail script if shell change fails - it's not critical
        set_zsh_as_default_shell || true
        log_info "Note: You may need to log out and back in for the shell change to take effect"
    fi
{{- end }}
    exit 0
fi

{{- if .is_remote }}
log_info "Remote machine detected - skipping system package installation (requires sudo)"
log_info "Install missing packages manually if needed: git, curl, make, unzip"
{{- else }}
log_info "Installing base system packages..."

# Detect package manager and install
if command_exists pacman; then
    log_info "Using pacman (Arch Linux)"
    packages="sudo base-devel git curl wget unzip zip openssl readline zlib libyaml libffi zsh"
    if [ "$EUID" -eq 0 ]; then
        pacman -Syu --noconfirm $packages
    elif command_exists sudo; then
        sudo pacman -Syu --noconfirm $packages
    else
        log_warning "Neither running as root nor sudo available - attempting pacman without privilege escalation"
        log_warning "This will likely fail. Please run manually: wsl -d archlinux -u root pacman -Syu --noconfirm $packages"
        exit 1
    fi
elif command_exists apt-get; then
    log_info "Using apt-get (Debian/Ubuntu)"
    packages="git curl wget unzip zip build-essential libssl-dev libreadline-dev zlib1g-dev libyaml-dev libffi-dev zsh"
    if [ "$EUID" -eq 0 ]; then
        apt-get update && apt-get install -y $packages
    elif command_exists sudo; then
        sudo apt-get update && sudo apt-get install -y $packages
    else
        log_warning "Neither running as root nor sudo available"
        exit 1
    fi
elif command_exists dnf; then
    log_info "Using dnf (Fedora/RHEL)"
    packages="git curl wget unzip zip gcc gcc-c++ make openssl-devel readline-devel zlib-devel libyaml-devel libffi-devel zsh"
    if [ "$EUID" -eq 0 ]; then
        dnf install -y $packages
    elif command_exists sudo; then
        sudo dnf install -y $packages
    else
        log_warning "Neither running as root nor sudo available"
        exit 1
    fi
elif command_exists brew; then
    log_info "Using brew (macOS)"
    brew install git curl wget unzip openssl readline libyaml libffi zsh
else
    log_warning "No supported package manager found"
    exit 0
fi

log_success "Base packages installed"

# Set zsh as default shell if installed
if command_exists zsh; then
    set_zsh_as_default_shell || true
    log_info "Note: You may need to log out and back in for the shell change to take effect"
fi
{{- end }}

# Create XDG directories
log_info "Creating XDG directories..."
mkdir -p "${XDG_CONFIG_HOME:-$HOME/.config}"
mkdir -p "${XDG_DATA_HOME:-$HOME/.local/share}"
mkdir -p "${XDG_STATE_HOME:-$HOME/.local/state}"
mkdir -p "${XDG_CACHE_HOME:-$HOME/.cache}"
mkdir -p "$HOME/.local/bin"
log_success "XDG directories created"

# Symlink Arch perl scripts (needed for Homebrew builds)
if [ -d /usr/bin/core_perl ] && [ -x /usr/bin/core_perl/pod2man ]; then
    log_info "Creating perl script symlinks for Homebrew compatibility..."
{{- if not .is_remote }}
    if command_exists sudo; then
        for script in pod2man pod2html pod2text podchecker; do
            if [ -x "/usr/bin/core_perl/$script" ]; then
                [ ! -e "/usr/bin/$script" ] && sudo ln -sf "/usr/bin/core_perl/$script" "/usr/bin/$script" 2>/dev/null || true
                [ ! -e "/usr/local/bin/$script" ] && sudo ln -sf "/usr/bin/core_perl/$script" "/usr/local/bin/$script" 2>/dev/null || true
            fi
        done
    fi
{{- end }}
    # User-space symlinks in ~/.local/bin
    for script in pod2man pod2html pod2text podchecker; do
        if [ -x "/usr/bin/core_perl/$script" ] && [ ! -e "$HOME/.local/bin/$script" ]; then
            ln -sf "/usr/bin/core_perl/$script" "$HOME/.local/bin/$script"
        fi
    done
    log_success "Perl script symlinks created"
fi

# Install Homebrew (Linux/WSL - user install to ~/.local/share/homebrew)
{{- if and (ne .chezmoi.os "darwin") (not .is_remote) }}
install_homebrew() {
    if command_exists brew; then
        log_success "Homebrew already installed"
        return 0
    fi
    
    log_info "Installing Homebrew to ~/.local/share/homebrew..."
    
    # Set HOMEBREW_PREFIX for user install (not /home/linuxbrew)
    export HOMEBREW_PREFIX="$HOME/.local/share/homebrew"
    export HOMEBREW_CELLAR="$HOMEBREW_PREFIX/Cellar"
    export HOMEBREW_REPOSITORY="$HOMEBREW_PREFIX"
    export PATH="$HOMEBREW_PREFIX/bin:$HOMEBREW_PREFIX/sbin:$PATH"
    
    # Create homebrew directory
    mkdir -p "$HOMEBREW_PREFIX"
    
    # Clone homebrew
    if [ ! -d "$HOMEBREW_PREFIX/.git" ]; then
        git clone --depth=1 https://github.com/Homebrew/brew "$HOMEBREW_PREFIX" || {
            log_warning "Failed to clone Homebrew"
            return 1
        }
    fi
    
    # Verify brew works
    if "$HOMEBREW_PREFIX/bin/brew" --version >/dev/null 2>&1; then
        log_success "Homebrew installed to $HOMEBREW_PREFIX"
        # Update homebrew
        "$HOMEBREW_PREFIX/bin/brew" update --force --quiet || true
    else
        log_warning "Homebrew installation failed"
        return 1
    fi
}

install_homebrew
{{- end }}

{{- if and .setup_1password (not .is_remote) }}
# Install 1Password CLI (requires system package manager for setgid permissions)
install_1password_cli() {
    if command_exists op; then
        log_success "1Password CLI already installed"
        return 0
    fi

    log_info "Installing 1Password CLI..."

    if command_exists pacman; then
        # 1password-cli is in AUR, not official repos
        if command_exists paru; then
            paru -S --noconfirm 1password-cli
        elif command_exists yay; then
            yay -S --noconfirm 1password-cli
        else
            log_warning "No AUR helper found (paru/yay). Install 1password-cli manually:"
            log_warning "  paru -S 1password-cli  OR  yay -S 1password-cli"
            return 1
        fi
    elif command_exists apt-get; then
        if command_exists sudo; then
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
                sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg 2>/dev/null || true
            echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main' | \
                sudo tee /etc/apt/sources.list.d/1password.list >/dev/null
            sudo apt-get update && sudo apt-get install -y 1password-cli
        else
            log_warning "sudo required to install 1password-cli"
            return 1
        fi
    elif command_exists dnf; then
        if command_exists sudo; then
            sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
            sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://downloads.1password.com/linux/keys/1password.asc" > /etc/yum.repos.d/1password.repo'
            sudo dnf install -y 1password-cli
        else
            log_warning "sudo required to install 1password-cli"
            return 1
        fi
    elif command_exists brew; then
        brew install 1password-cli
    else
        log_warning "Cannot auto-install 1Password CLI. Install manually."
        return 1
    fi

    if command_exists op; then
        log_success "1Password CLI installed"
    fi
}

# Install 1Password desktop app (required for SSH agent)
install_1password_desktop() {
    # Check if already installed
    if command_exists 1password || [ -f /opt/1Password/1password ]; then
        log_success "1Password desktop app already installed"
        return 0
    fi

    log_info "Installing 1Password desktop app (required for SSH agent)..."

    if command_exists pacman; then
        # Arch Linux - try AUR helpers
        if command_exists paru; then
            log_info "Installing 1password via paru..."
            paru -S --noconfirm 1password || log_warning "Failed to install 1password via paru"
        elif command_exists yay; then
            log_info "Installing 1password via yay..."
            yay -S --noconfirm 1password || log_warning "Failed to install 1password via yay"
        else
            log_warning "No AUR helper found (paru/yay). Install 1Password manually:"
            log_warning "  paru -S 1password  OR  yay -S 1password"
            return 1
        fi
    elif command_exists apt-get; then
        # Debian/Ubuntu - add 1Password repo
        log_info "Adding 1Password apt repository..."
        if command_exists sudo; then
            curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
                sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg 2>/dev/null || true
            echo 'deb [arch=amd64 signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/amd64 stable main' | \
                sudo tee /etc/apt/sources.list.d/1password.list >/dev/null
            sudo apt-get update && sudo apt-get install -y 1password || log_warning "Failed to install 1password via apt"
        else
            log_warning "sudo required to add 1Password repo. Install manually."
            return 1
        fi
    elif command_exists dnf; then
        # Fedora/RHEL - add 1Password repo
        log_info "Adding 1Password rpm repository..."
        if command_exists sudo; then
            sudo rpm --import https://downloads.1password.com/linux/keys/1password.asc
            sudo sh -c 'echo -e "[1password]\nname=1Password Stable Channel\nbaseurl=https://downloads.1password.com/linux/rpm/stable/\$basearch\nenabled=1\ngpgcheck=1\nrepo_gpgcheck=1\ngpgkey=https://downloads.1password.com/linux/keys/1password.asc" > /etc/yum.repos.d/1password.repo'
            sudo dnf install -y 1password || log_warning "Failed to install 1password via dnf"
        else
            log_warning "sudo required to add 1Password repo. Install manually."
            return 1
        fi
    elif command_exists brew; then
        # macOS
        log_info "Installing 1Password via Homebrew cask..."
        brew install --cask 1password || log_warning "Failed to install 1password via brew"
    else
        log_warning "Cannot auto-install 1Password desktop. Install manually from:"
        log_warning "  https://1password.com/downloads/linux/"
        return 1
    fi

    if command_exists 1password || [ -f /opt/1Password/1password ]; then
        log_success "1Password desktop app installed"
        log_info "Remember to enable 'Integrate with 1Password CLI' in Settings > Developer"
    fi
}

install_1password_cli
install_1password_desktop
{{- end }}

{{- end -}}
