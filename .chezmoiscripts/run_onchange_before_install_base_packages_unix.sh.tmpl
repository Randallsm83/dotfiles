{{- if ne .chezmoi.os "windows" -}}
#!/usr/bin/env bash
#
# Install base system packages required for building software
# This runs BEFORE other package installations
# Checksum: {{ include ".chezmoidata.yaml" | sha256sum }}

set -eo pipefail

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

log_success() {
    echo -e "${GREEN}✓${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

is_zsh_default_shell() {
    local current_shell
    if [ -n "$SUDO_USER" ]; then
        current_shell=$(getent passwd "$SUDO_USER" | cut -d: -f7)
    else
        current_shell=$(getent passwd "$USER" | cut -d: -f7)
    fi
    [ "$current_shell" = "$(command -v zsh)" ] || [ "$current_shell" = "/bin/zsh" ] || [ "$current_shell" = "/usr/bin/zsh" ]
}

set_zsh_as_default_shell() {
    if ! command_exists zsh; then
        log_warning "zsh not found in PATH, skipping shell change"
        return 1
    fi
    
    if is_zsh_default_shell; then
        log_success "zsh is already the default shell"
        return 0
    fi
    
    local zsh_path
    zsh_path=$(command -v zsh)
    
    log_info "Setting zsh as default shell..."
    log_warning "You may be prompted for your password"
    
    if [ "$EUID" -eq 0 ] && [ -n "$SUDO_USER" ]; then
        # Running as root, change shell for the actual user
        if chsh -s "$zsh_path" "$SUDO_USER" 2>/dev/null; then
            log_success "Default shell changed to zsh for user $SUDO_USER"
            return 0
        fi
    else
        # Running as normal user
        if chsh -s "$zsh_path" 2>/dev/null; then
            log_success "Default shell changed to zsh"
            return 0
        fi
    fi
    
    # chsh failed - provide fallback instructions
    log_warning "Failed to change default shell automatically"
    log_warning "Please run manually: chsh -s $zsh_path"
    log_warning "Or add this to /etc/passwd if in a container environment"
    return 1
}

# Check if we need to install packages
needs_install=false

if ! command_exists git; then
    log_warning "git not found"
    needs_install=true
fi

if ! command_exists curl; then
    log_warning "curl not found"
    needs_install=true
fi

if ! command_exists make; then
    log_warning "make not found"
    needs_install=true
fi

if ! command_exists unzip; then
    log_warning "unzip not found"
    needs_install=true
fi

if [ "$needs_install" = false ]; then
    log_success "Base packages already installed"
    exit 0
fi

log_info "Installing base system packages..."

# Detect package manager and install
if command_exists pacman; then
    log_info "Using pacman (Arch Linux)"
    packages="sudo base-devel git curl wget unzip zip openssl readline zlib libyaml libffi zsh"
    if [ "$EUID" -eq 0 ]; then
        pacman -Syu --noconfirm $packages
    elif command_exists sudo; then
        sudo pacman -Syu --noconfirm $packages
    else
        log_warning "Neither running as root nor sudo available - attempting pacman without privilege escalation"
        log_warning "This will likely fail. Please run manually: wsl -d archlinux -u root pacman -Syu --noconfirm $packages"
        exit 1
    fi
elif command_exists apt-get; then
    log_info "Using apt-get (Debian/Ubuntu)"
    packages="git curl wget unzip zip build-essential libssl-dev libreadline-dev zlib1g-dev libyaml-dev libffi-dev zsh"
    if [ "$EUID" -eq 0 ]; then
        apt-get update && apt-get install -y $packages
    elif command_exists sudo; then
        sudo apt-get update && sudo apt-get install -y $packages
    else
        log_warning "Neither running as root nor sudo available"
        exit 1
    fi
elif command_exists dnf; then
    log_info "Using dnf (Fedora/RHEL)"
    packages="git curl wget unzip zip gcc gcc-c++ make openssl-devel readline-devel zlib-devel libyaml-devel libffi-devel zsh"
    if [ "$EUID" -eq 0 ]; then
        dnf install -y $packages
    elif command_exists sudo; then
        sudo dnf install -y $packages
    else
        log_warning "Neither running as root nor sudo available"
        exit 1
    fi
elif command_exists brew; then
    log_info "Using brew (macOS)"
    brew install git curl wget unzip openssl readline libyaml libffi zsh
else
    log_warning "No supported package manager found"
    exit 0
fi

log_success "Base packages installed"

# Set zsh as default shell if installed
if command_exists zsh; then
    set_zsh_as_default_shell
    log_info "Note: You may need to log out and back in for the shell change to take effect"
fi

{{- end -}}
