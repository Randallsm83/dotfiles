{{- if ne .chezmoi.os "windows" -}}
#!/bin/sh
# Declarative package installation for Unix (Linux/macOS)
# This script only runs when package lists change
# Hash: {{ include ".chezmoidata.yaml" | sha256sum }}

echo "Checking package installation..."

# Detect system package manager (Linux only, for bootstrap packages)
detect_pkg_manager() {
    if command -v apt-get >/dev/null 2>&1; then
        echo "apt"
    elif command -v dnf >/dev/null 2>&1; then
        echo "dnf"
    elif command -v pacman >/dev/null 2>&1; then
        echo "pacman"
    else
        echo ""
    fi
}

# Ensure mise is installed
if ! command -v mise >/dev/null 2>&1; then
    echo "mise not found. Installing..."
    curl https://mise.run | sh
    export PATH="$HOME/.local/bin:$PATH"
fi

# Collect packages per manager
mise_packages=""
brew_packages=""
apt_packages=""
dnf_packages=""
pacman_packages=""

{{- range $feature, $enabled := .package_features }}
{{- if $enabled }}
{{- $mapping := index $.package_mapping $feature }}
{{- if $mapping }}
{{- $platform := index $mapping $.chezmoi.os }}
{{- if $platform }}
{{- range $platform.mise }}
mise_packages="$mise_packages {{ . }}"
{{- end }}
{{- range $platform.brew }}
brew_packages="$brew_packages {{ . }}"
{{- end }}
{{- if eq $.chezmoi.os "linux" }}
{{- range $platform.apt }}
apt_packages="$apt_packages {{ . }}"
{{- end }}
{{- range $platform.dnf }}
dnf_packages="$dnf_packages {{ . }}"
{{- end }}
{{- range $platform.pacman }}
pacman_packages="$pacman_packages {{ . }}"
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}

# ============================================================================
# Package Installation Order (per user rules):
#   1. mise - primary package manager for CLI tools and runtimes
#   2. brew - fallback for tools not available in mise
#   3. system pkg manager - ONLY for bootstrap/build dependencies
# ============================================================================

# 1. Install mise packages globally (PRIMARY)
if [ -n "$mise_packages" ]; then
    echo ""
    echo "Installing mise tools/runtimes globally..."
    
    # Check if any cargo packages are requested - install rust first
    if echo "$mise_packages" | grep -q "cargo:"; then
        if ! mise list rust 2>/dev/null | grep -q "rust"; then
            echo "  Installing: rust@stable (required for cargo packages)"
            mise use -g rust@stable
        fi
    fi
    
    for pkg in $mise_packages; do
        tool_name=$(echo "$pkg" | sed 's/@.*$//' | sed 's/cargo://')
        if ! mise list "$tool_name" 2>/dev/null | grep -q "$tool_name"; then
            echo "  Installing: $pkg"
            mise use -g "$pkg" || echo "  Warning: Failed to install $pkg, continuing..."
        else
            echo "  Already installed: $pkg"
        fi
    done
    
    # Ensure shims are in PATH for subsequent operations
    export PATH="$HOME/.local/share/mise/shims:$PATH"
fi

# 2. Install brew packages (FALLBACK for tools not in mise)
if [ -n "$brew_packages" ]; then
    if command -v brew >/dev/null 2>&1; then
        echo ""
        echo "Installing brew packages (tools not available via mise)..."
        for pkg in $brew_packages; do
            if ! brew list "$pkg" >/dev/null 2>&1; then
                echo "  Installing: $pkg"
                brew install "$pkg"
            else
                echo "  Already installed: $pkg"
            fi
        done
    else
        echo ""
        echo "Note: brew not found, skipping brew-only packages"
        echo "      (These are optional tools not available via mise)"
    fi
fi

# 3. Install system packages (ONLY for bootstrap/build dependencies)
{{- if eq .chezmoi.os "linux" }}
pkg_manager=$(detect_pkg_manager)
if [ -n "$pkg_manager" ]; then
    case "$pkg_manager" in
        apt)
            if [ -n "$apt_packages" ]; then
                echo ""
                echo "Installing build dependencies via apt..."
                sudo apt-get update -qq
                for pkg in $apt_packages; do
                    if ! dpkg -l "$pkg" 2>/dev/null | grep -q "^ii"; then
                        echo "  Installing: $pkg"
                        sudo apt-get install -y -qq "$pkg"
                    else
                        echo "  Already installed: $pkg"
                    fi
                done
            fi
            ;;
        dnf)
            if [ -n "$dnf_packages" ]; then
                echo ""
                echo "Installing build dependencies via dnf..."
                for pkg in $dnf_packages; do
                    if ! rpm -q "$pkg" >/dev/null 2>&1; then
                        echo "  Installing: $pkg"
                        sudo dnf install -y -q "$pkg"
                    else
                        echo "  Already installed: $pkg"
                    fi
                done
            fi
            ;;
        pacman)
            if [ -n "$pacman_packages" ]; then
                echo ""
                echo "Installing build dependencies via pacman..."
                for pkg in $pacman_packages; do
                    if ! pacman -Q "$pkg" >/dev/null 2>&1; then
                        echo "  Installing: $pkg"
                        sudo pacman -S --noconfirm "$pkg"
                    else
                        echo "  Already installed: $pkg"
                    fi
                done
            fi
            ;;
    esac
fi
{{- end }}

# Helper to check if a command exists AND works (not a broken Windows interop path)
command_works() {
    command -v "$1" >/dev/null 2>&1 && "$1" --version >/dev/null 2>&1
}

{{- if and .package_features.nvim .package_features.python }}
# pip pynvim package (for Python provider)
echo ""
echo "Installing Neovim Python provider..."
if command_works pip || command_works pip3; then
    pip_cmd="pip"
    command_works pip || pip_cmd="pip3"
    if ! $pip_cmd show pynvim >/dev/null 2>&1; then
        echo "  Installing: pynvim (Python provider)"
        $pip_cmd install --user pynvim || echo "  Warning: Failed to install pynvim"
    else
        echo "  Already installed: pynvim"
    fi
else
    echo "  pip not available, skipping Python provider"
fi
{{- end }}

{{- if and .package_features.nvim .package_features.node }}
# npm neovim package (for Node.js provider)
echo ""
echo "Installing Neovim Node.js provider..."
if command_works npm; then
    if ! npm list -g neovim >/dev/null 2>&1; then
        echo "  Installing: npm neovim (Node.js provider)"
        npm install -g neovim || echo "  Warning: Failed to install neovim npm package"
    else
        echo "  Already installed: npm neovim"
    fi
else
    echo "  npm not available, skipping Node.js provider"
fi
{{- end }}

{{- if and .package_features.nvim .package_features.ruby }}
# gem neovim package (for Ruby provider)
echo ""
echo "Installing Neovim Ruby provider..."
if command_works ruby && command_works gem; then
    if ! gem list neovim 2>/dev/null | grep -q "^neovim "; then
        echo "  Installing: neovim gem (Ruby provider)"
        gem install neovim || echo "  Warning: Failed to install neovim gem"
    else
        echo "  Already installed: neovim gem"
    fi
else
    echo "  ruby/gem not available, skipping Ruby provider"
fi
{{- end }}

{{- if and .package_features.nvim .package_features.perl }}
# cpan Neovim::Ext module (for Perl provider)
echo ""
echo "Installing Neovim Perl provider..."
# Only use Linux perl, not Windows Strawberry Perl via WSL interop
if [ -x /usr/bin/perl ] || command_works perl; then
    if ! perl -MNeovim::Ext -e 1 >/dev/null 2>&1; then
        echo "  Installing: Neovim::Ext (Perl provider)"
        if command_works cpanm; then
            cpanm -n Neovim::Ext || echo "  Warning: Failed to install Neovim::Ext"
        elif command -v cpan >/dev/null 2>&1; then
            cpan -T Neovim::Ext || echo "  Warning: Failed to install Neovim::Ext"
        else
            echo "  Neither cpanm nor cpan available, skipping Perl provider"
        fi
    else
        echo "  Already installed: Neovim::Ext"
    fi
else
    echo "  perl not available, skipping Perl provider"
fi
{{- end }}

echo ""
echo "âœ“ Package installation complete"
{{- end -}}
