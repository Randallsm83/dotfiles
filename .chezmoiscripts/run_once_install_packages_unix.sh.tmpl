{{- if ne .chezmoi.os "windows" -}}
{{ template "common-header" . }}
{{ template "platform-detect" . }}
{{ template "package-manager" . }}

#
# Install packages on Unix (Linux/WSL/macOS)
# This script uses the template library for consistency
# Hash: {{ include ".chezmoidata.yaml" | sha256sum }}

# ============================================================================
# Configuration
# ============================================================================

IS_REMOTE={{ .is_remote }}
REMOTE_MINIMAL={{ .remote_minimal }}
INSTALL_PACKAGES={{ .install_packages }}
HAS_SUDO={{ .has_sudo }}

# ============================================================================
# Main Installation Logic
# ============================================================================

log_info "═══════════════════════════════════════════"
log_info "   Installing Unix Packages"
log_info "═══════════════════════════════════════════"
log_info ""

# Print platform information
print_platform_info
log_info ""

# Check if we should skip installation
if [ "$INSTALL_PACKAGES" = "false" ]; then
    log_info "Package installation disabled (install_packages=false)"
    log_info "To enable: set install_packages=true in .chezmoi.local.toml"
    exit 0
fi

# Print remote/sudo status
if [ "$IS_REMOTE" = "true" ]; then
    log_info "Remote machine detected"
    if [ "$REMOTE_MINIMAL" = "true" ]; then
        log_info "Using minimal package set for remote environment"
    fi
fi

if [ "$HAS_SUDO" = "false" ]; then
    log_warning "No sudo access - using user-space installations only"
    log_info "All tools will be installed via mise to ~/.local/"
fi
log_info ""

# Install mise if not present
if ! command_exists mise; then
    log_info "Installing mise package manager..."
    if is_dry_run; then
        log_info "[DRY RUN] Would install mise from https://mise.run"
    else
        curl -fsSL https://mise.run | sh
        export PATH="$HOME/.local/bin:$PATH"
        
        # Activate mise for current shell
        if [ -f "$HOME/.local/bin/mise" ]; then
            eval "$("$HOME/.local/bin/mise" activate bash)"
        fi
    fi
else
    log_success "mise already installed"
fi

# Verify mise is available
if command_exists mise; then
    local mise_version
    mise_version="$(mise --version 2>/dev/null | head -1 || echo 'unknown')"
    log_success "mise is available (${mise_version})"

    # Ensure mise is on PATH for this session for shims
    export PATH="$HOME/.local/bin:$HOME/.local/share/mise/shims:$PATH"
    
    log_info "Installing tools and runtimes via mise configuration..."
    log_info "Config files:"
    log_info "  - ~/.config/mise/config.toml"
    {{- if and .is_remote .remote_minimal }}
    log_info "  - ~/.config/mise/config.remote.toml (remote minimal)"
    {{- end }}
    {{- if eq .chezmoi.os "linux" }}
    log_info "  - ~/.config/mise/config.linux.toml"
    {{- else if eq .chezmoi.os "darwin" }}
    log_info "  - ~/.config/mise/config.darwin.toml"
    {{- end }}
    
    # Install mise tools with parallel jobs
    if is_dry_run; then
        log_info "[DRY RUN] Would run: mise install -j 4"
    else
        if [ "$IS_REMOTE" = "true" ] && [ "$REMOTE_MINIMAL" = "true" ]; then
            log_info "Installing minimal remote toolset with mise..."
            export MISE_CONFIG_FILES="$HOME/.config/mise/config.toml:$HOME/.config/mise/config.remote.toml"
        else
            log_info "Installing full toolset with mise..."
        fi
        if mise install -j 4 2>&1 | tee -a "${LOG_FILE}"; then
            log_success "Mise tools installed successfully"
        else
            log_warning "Some mise installations may have failed (check log)"
        fi
    fi
    
{{- if .package_features.thefuck }}
    # Inject setuptools into thefuck venv (required for Python 3.12+)
    # distutils was removed in Python 3.12, thefuck depends on it via setuptools
    if command_exists thefuck; then
        log_info "Injecting setuptools into thefuck for Python 3.12+ compatibility..."
        thefuck_install_dir=$(mise where 'pipx:git+https://github.com/nvbn/thefuck.git' 2>/dev/null)
        if [ -n "$thefuck_install_dir" ] && [ -d "$thefuck_install_dir/thefuck" ]; then
            thefuck_venv="$thefuck_install_dir/thefuck"
            if [ -f "$thefuck_venv/bin/python" ]; then
                if command_exists uv; then
                    uv pip install --quiet --python "$thefuck_venv/bin/python" setuptools && \
                        log_success "setuptools injected into thefuck" || \
                        log_warning "Failed to inject setuptools into thefuck"
                else
                    log_warning "uv not available to inject setuptools into thefuck"
                fi
            else
                log_warning "Could not find python in thefuck venv at $thefuck_venv"
            fi
        else
            log_warning "Could not determine thefuck install location"
        fi
    fi
{{- end }}

    # Verify key tools
    log_info "Verifying key tools..."
    local tools_full=("node" "python" "ruby" "go" "rust")
    local tools_min=("node" "python" "go")
    local tools_to_check=()
    if [ "$IS_REMOTE" = "true" ] && [ "$REMOTE_MINIMAL" = "true" ]; then
        tools_to_check=("${tools_min[@]}")
    else
        tools_to_check=("${tools_full[@]}")
    fi
    for tool in "${tools_to_check[@]}"; do
        if command_exists "${tool}"; then
            local version
            version="$(get_package_version "${tool}")"
            log_success "${tool}: ${version}"
        else
            log_warning "${tool}: not found"
        fi
    done
else
    log_error "mise not available after installation attempt"
    log_error "Package installation cannot proceed"
    exit 1
fi

log_info ""
log_success "Package installation completed!"
log_info "Check log file: ${LOG_FILE}"
log_info ""
{{- end -}}
