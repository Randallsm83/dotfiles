{{- if ne .chezmoi.os "windows" -}}
# Zsh configuration - Managed by chezmoi
# Last updated: {{ now | date "2006-01-02" }}

# XDG Base Directory specification (set in zshenv, but verify)
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-$HOME/.local/state}"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-$HOME/.cache}"

# Ensure state directory exists for history
mkdir -p "$XDG_STATE_HOME/zsh"

# History configuration
HISTFILE="$XDG_STATE_HOME/zsh/history"
HISTSIZE=10000
SAVEHIST=10000
setopt SHARE_HISTORY              # Share history between sessions
setopt HIST_IGNORE_ALL_DUPS       # Remove older duplicate entries
setopt HIST_REDUCE_BLANKS         # Remove superfluous blanks
setopt HIST_IGNORE_SPACE          # Don't save commands starting with space
setopt HIST_VERIFY                # Show command before executing from history
setopt EXTENDED_HISTORY           # Save timestamp and duration

# Completion system
autoload -Uz compinit
# Use XDG directory for completion dump
mkdir -p "$XDG_CACHE_HOME/zsh"
compinit -d "$XDG_CACHE_HOME/zsh/zcompdump"

# Completion options
setopt AUTO_MENU                  # Show completion menu on tab
setopt COMPLETE_IN_WORD          # Complete from both ends
setopt ALWAYS_TO_END             # Move cursor to end after completion

# Directory navigation
setopt AUTO_CD                   # cd by typing directory name
setopt AUTO_PUSHD                # Make cd push old directory onto stack
setopt PUSHD_IGNORE_DUPS        # Don't push duplicates
setopt PUSHD_SILENT             # Don't print directory stack

# Initialize Starship prompt
eval "$(starship init zsh)"

# Initialize Mise (tool version manager)
eval "$(mise activate zsh)"

# Initialize Zoxide (smart cd)
eval "$(zoxide init zsh)"

# Set LS_COLORS using Vivid ({{ .theme.name }} theme)
{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") }}
if command -v vivid &> /dev/null; then
    export LS_COLORS="$(vivid generate {{ .theme.name }})"
fi
{{- end }}

# Aliases - Modern CLI replacements
{{- if or (eq .chezmoi.os "linux") (eq .chezmoi.os "darwin") }}
alias ll='eza -l --icons --git'
alias la='eza -la --icons --git'
alias lt='eza -T --icons --git-ignore'
alias llt='eza -lT --icons --git-ignore'
alias cat='bat'
alias grep='rg'
{{- end }}

# Git shortcuts
alias gs='git status'
alias gp='git push'
alias gl='git pull'
alias ga='git add'
alias gc='git commit -m'
alias gco='git checkout'
alias gb='git branch'
alias gd='git diff'
alias gds='git diff --staged'
alias glog='git log --oneline --graph --decorate'

# Utility aliases
alias c='clear'
alias h='history'
alias j='jobs'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Platform-specific configurations
{{- if eq .chezmoi.os "darwin" }}
# macOS-specific settings
# Add Homebrew to PATH (if installed during bootstrap)
if [ -d "/opt/homebrew/bin" ]; then
    export PATH="/opt/homebrew/bin:$PATH"
fi
{{- end }}

{{- if and (eq .chezmoi.os "linux") (or (.chezmoi.kernel.osrelease | lower | contains "microsoft") (.chezmoi.kernel.osrelease | lower | contains "wsl")) }}
# WSL-specific settings
# Set DISPLAY for X11 forwarding
export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}'):0

# WSL utilities
alias open='explorer.exe'
alias pbcopy='clip.exe'

# Windows interop helpers
export BROWSER='wslview'
{{- end }}

# 1Password SSH Agent integration
{{- if .features.setup_1password }}
export SSH_AUTH_SOCK="$HOME/.1password/agent.sock"
{{- end }}

# Additional PATH entries
export PATH="$HOME/.local/bin:$PATH"

# Vi mode key bindings (optional - uncomment if desired)
# bindkey -v
# export KEYTIMEOUT=1  # Reduce delay when switching modes

# Custom functions
mkcd() {
    mkdir -p "$1" && cd "$1"
}

# Extract various archive types
extract() {
    if [ -f "$1" ]; then
        case "$1" in
            *.tar.bz2)   tar xjf "$1"    ;;
            *.tar.gz)    tar xzf "$1"    ;;
            *.bz2)       bunzip2 "$1"    ;;
            *.rar)       unrar x "$1"    ;;
            *.gz)        gunzip "$1"     ;;
            *.tar)       tar xf "$1"     ;;
            *.tbz2)      tar xjf "$1"    ;;
            *.tgz)       tar xzf "$1"    ;;
            *.zip)       unzip "$1"      ;;
            *.Z)         uncompress "$1" ;;
            *.7z)        7z x "$1"       ;;
            *)           echo "'$1' cannot be extracted via extract()" ;;
        esac
    else
        echo "'$1' is not a valid file"
    fi
}

# Welcome message (optional - comment out if you prefer clean startup)
# echo "Welcome, {{ .user.name }}!"
{{- end -}}
