# Chezmoi configuration file
# https://www.chezmoi.io/reference/configuration-file/
# Version 2

{{- /* ========================================================================== */ -}}
{{- /* User Information (can be overridden in .chezmoi.local.toml)            */ -}}
{{- /* ========================================================================== */ -}}

{{- $email := "randallsm83@gmail.com" -}}
{{- $name := "Randall" -}}
{{- $github_username := "Randallsm83" -}}

{{- /* ========================================================================== */ -}}
{{- /* Platform Detection                                                      */ -}}
{{- /* ========================================================================== */ -}}

{{- $is_windows := eq .chezmoi.os "windows" -}}
{{- $is_darwin := eq .chezmoi.os "darwin" -}}
{{- $is_linux := eq .chezmoi.os "linux" -}}
{{- $is_wsl := and $is_linux (or (.chezmoi.kernel.osrelease | lower | contains "microsoft") (.chezmoi.kernel.osrelease | lower | contains "wsl")) -}}

{{- /* ========================================================================== */ -}}
{{- /* Machine Type Detection (Remote/Personal/Work)                          */ -}}
{{- /* ========================================================================== */ -}}

{{- $hostname := .chezmoi.hostname | lower -}}

{{- /* Check for remote indicators */ -}}
{{- $is_remote := or (ne (env "SSH_CONNECTION") "") (ne (env "SSH_CLIENT") "") (ne (env "SSH_TTY") "") (eq (env "TERM_PROGRAM") "vscode") -}}

{{- /* Check for container */ -}}
{{- $is_container := false -}}
{{- if $is_linux -}}
  {{- if stat "/.dockerenv" -}}
    {{- $is_container = true -}}
  {{- end -}}
{{- end -}}

{{- /* Classify machine based on hostname patterns */ -}}
{{- $is_work := false -}}
{{- $is_personal := false -}}

{{- if or (contains "work" $hostname) (contains "corp" $hostname) (contains "company" $hostname) (contains "office" $hostname) -}}
  {{- $is_work = true -}}
{{- else if or (contains "home" $hostname) (contains "personal" $hostname) (contains "laptop" $hostname) (contains "desktop" $hostname) -}}
  {{- $is_personal = true -}}
{{- else if not $is_remote -}}
  {{- /* Default local machines to personal */ -}}
  {{- $is_personal = true -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* Permission Detection                                                    */ -}}
{{- /* ========================================================================== */ -}}

{{- /* On Unix, we'll check sudo at runtime, but we can make educated guesses */ -}}
{{- $has_sudo := false -}}
{{- if $is_windows -}}
  {{- /* Windows always has admin capability (elevation) */ -}}
  {{- $has_sudo = true -}}
{{- else if not $is_remote -}}
  {{- /* Local machines typically have sudo */ -}}
  {{- $has_sudo = true -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* XDG Base Directory Specification                                        */ -}}
{{- /* https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html */ -}}
{{- /* ========================================================================== */ -}}

{{- $xdg_config_home := "" -}}
{{- $xdg_data_home := "" -}}
{{- $xdg_state_home := "" -}}
{{- $xdg_cache_home := "" -}}

{{- if $is_windows -}}
  {{- $xdg_config_home = joinPath .chezmoi.homeDir ".config" -}}
  {{- $xdg_data_home = joinPath .chezmoi.homeDir ".local" "share" -}}
  {{- $xdg_state_home = joinPath .chezmoi.homeDir ".local" "state" -}}
  {{- $xdg_cache_home = joinPath .chezmoi.homeDir ".cache" -}}
{{- else -}}
  {{- $xdg_config_home = joinPath .chezmoi.homeDir ".config" -}}
  {{- $xdg_data_home = joinPath .chezmoi.homeDir ".local" "share" -}}
  {{- $xdg_state_home = joinPath .chezmoi.homeDir ".local" "state" -}}
  {{- $xdg_cache_home = joinPath .chezmoi.homeDir ".cache" -}}
{{- end -}}

{{- /* ========================================================================== */ -}}
{{- /* Data Section - Exposed to all templates                                 */ -}}
{{- /* ========================================================================== */}}

[data]
    # User information
    email = {{ $email | quote }}
    name = {{ $name | quote }}
    github_username = {{ $github_username | quote }}
    
    # Platform detection flags
    is_windows = {{ $is_windows }}
    is_darwin = {{ $is_darwin }}
    is_linux = {{ $is_linux }}
    is_wsl = {{ $is_wsl }}
    is_container = {{ $is_container }}
    
    # Machine type classification
    is_remote = {{ $is_remote }}
    is_personal = {{ $is_personal }}
    is_work = {{ $is_work }}
    has_sudo = {{ $has_sudo }}  # Estimated, scripts should verify at runtime
    hostname = {{ .chezmoi.hostname | quote }}
    
    # XDG Base Directory paths
    xdg_config_home = {{ $xdg_config_home | quote }}
    xdg_data_home = {{ $xdg_data_home | quote }}
    xdg_state_home = {{ $xdg_state_home | quote }}
    xdg_cache_home = {{ $xdg_cache_home | quote }}

    # Package manager preferences
{{- if $is_windows }}
    package_manager_cli = "scoop"
    package_manager_gui = "winget"
    runtime_manager = "mise"
{{- else if $is_darwin }}
    package_manager = "homebrew"
    runtime_manager = "mise"
{{- else }}
    package_manager = "mise"
    runtime_manager = "mise"
{{- end }}

    # Shell preferences
{{- if $is_windows }}
    shell = "pwsh"
    shell_profile = {{ joinPath .chezmoi.homeDir "Documents" "PowerShell" "Microsoft.PowerShell_profile.ps1" | quote }}
{{- else }}
    shell = "zsh"
    shell_profile = {{ joinPath .chezmoi.homeDir ".config" "zsh" ".zshrc" | quote }}
{{- end }}

    # Theme and styling (can be overridden via .chezmoi.local.toml or .chezmoidata.yaml)
    theme = "spaceduck"  # Primary: spaceduck, Secondary: onedark, gruvbox-material
    font = "Hack"
    font_fallback = "FiraCode"
    nerd_font = "Hack Nerd Font"
    
    # Feature flags (can be overridden in .chezmoi.local.toml)
    install_packages = {{ and (not $is_remote) (not $is_container) }}  # Skip on remote/containers by default
    install_runtimes = true
    setup_git_ssh = true
    setup_1password = {{ not $is_remote }}  # Skip on remote by default
    remote_minimal = {{ $is_remote }}  # Use minimal package set on remote machines

{{- /* ========================================================================== */ -}}
{{- /* Chezmoi Tool Configuration                                              */ -}}
{{- /* ========================================================================== */}}

# Tool configuration - these may not be available on first run
# Chezmoi will use built-in defaults if commands not found
[edit]
    command = "nvim"

[diff]
    # Delta provides nice diffs; falls back to built-in diff if not found
    # Uncomment after first chezmoi apply installs delta via mise
    # command = "delta"
    # args = ["--paging=never"]

[merge]
    command = "nvim"
    args = ["-d"]

{{- if $is_windows }}
# Use PowerShell 7 (pwsh.exe) instead of Windows PowerShell 5.1
[interpreters.ps1]
    command = "pwsh"
    args = ["-NoLogo", "-NoProfile", "-NonInteractive", "-ExecutionPolicy", "Bypass", "-File"]
{{- end }}

{{- /* ========================================================================== */ -}}
{{- /* 1Password Integration                                                   */ -}}
{{- /* ========================================================================== */}}

{{- if eq .chezmoi.os "windows" }}
[hooks.read-source-state.pre]
    command = "pwsh"
    args = ["-NoProfile", "-NonInteractive", "-ExecutionPolicy", "Bypass", "-File", "{{ .chezmoi.sourceDir }}/.install-1password.ps1"]
{{- else }}
[hooks.read-source-state.pre]
    command = "{{ .chezmoi.sourceDir }}/.install-1password.sh"
{{- end }}

[onepassword]
    prompt = false
{{- if $is_windows }}
    command = {{ joinPath .chezmoi.homeDir ".local" "bin" "op.exe" | quote }}
{{- end }}

{{- /* ========================================================================== */ -}}
{{- /* Git Repository Settings                                                 */ -}}
{{- /* ========================================================================== */}}

[git]
    autoCommit = false
    autoPush = false

{{- /* ========================================================================== */ -}}
{{- /* Local Overrides                                                         */ -}}
{{- /* ========================================================================== */ -}}
{{- /* Create a .chezmoi.local.toml file to override any settings above.       */ -}}
{{- /* Example: .chezmoi.local.toml                                            */ -}}
{{- /* [data]                                                                  */ -}}
{{- /*     is_work = true                                                      */ -}}
{{- /*     has_sudo = false                                                    */ -}}
{{- /*     install_packages = false                                            */ -}}
{{- /* ========================================================================== */ -}}
